# 区块链上钱包地址的交易监控

## 项目背景

该项目主要用于以下场景：监控一个钱包地址的交易信息，发现有某种交易（以Tron链上USDT币转入为例，下同）之后。需要按照一定的汇率和手续费计算后，给目标地址转入相应的trx币。

## 面临的问题：

1. 当程序当前块距离链上最新块偏移量较大时，如果按照逐块扫描的方式进行同步，那么会消耗较大时间才能更新到最新块，这样会影响入账交易的处理实时性。
2. 如果按照固定span（步长）来对最新块做同步的话，那么很有可能会超前扫描不存在的块，这样会导致一个问题：当不存在的块号，例如1000001在之后某个时间点上链之后，由于我们已经认为该块被扫描过，会导致其上的交易被忽略，导致漏掉交易的错误。
3. 为了解决2的问题，我们一般需要等待最新块和当前扫描块的偏移量达到步长之后再进行扫描和更新，那么就会有另一个问题：如果步长配置的较大，那么交易达到后，必须等待步长*块生成间隔的时间之后才能处理到，实时性较差。如果步长设置过小，那么在当前块在回溯等情况下，会使得更新到最新块的时间过长，导致1的问题。

## 方案设计

本方案采取了以下步骤来解决交易监控中存在的问题

1. 启动一个线程来实时获取当前链上最新块的块号（高度），记为currentNum。
2. 配置一个更新步长span。
3. 在一个循环中，比较当前已扫描的块号（高度）的值 lastNum与currentNum的差值，即 delta=currentNum-lastNum。
4. 根据delta做如下处理：
   - delta大于span时，按照span的步长来进行块追踪
   - delta大于1小于span时，按照delta来进行块追踪
   - delta等于1时，直接按照currentNum的块号来读取相关交易信息
   - 以上所有情况，包括delta小于等于0的情况下，都需要等待一定的时间间隔再进入下一次循环，这个间隔取决于查询api的访问qps限制
5. 如何根据delta来做块扫描：
   - tron链提供商tronscan提供的查询api中有两种可以查询交易：1.按照块号来查询指定块中的某些交易信息（记为按块查询接口）；2.按照指定的起止时间来查询这个时间段内的所有块上的某些交易信息（记为范围查询接口）。
   - 同时tronscan还提供获取块头部的api，可以根据块号来获取该块的生成时间。
   - 那么当delta大于span以及delta大于1的情况，首先根据需要查询的起止块号来获取到起止时间，然后通过范围查询接口来获取交易；当delta等于1时，通过按块查询接口来查询当前需要查询的块内的指定交易。

根据以上步骤可以看出，通过配置合适的步长，能够实现在短时间内同步到最新块。同时当我们同步到最新块之后，不必等待步长内的块全部准备就绪后再查询，而是可以实时查询到最新块上面的指定交易信息。达到了快速同步和实时更新的目的。
